<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Tic Tac Toe</title>
  <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <main class="game">
    <table class="board">
      <tr>
        <td onclick="makeMove(0, 0)"></td>
        <td onclick="makeMove(0, 1)"></td>
        <td onclick="makeMove(0, 2)"></td>
      </tr>
      <tr>
        <td onclick="makeMove(1, 0)"></td>
        <td onclick="makeMove(1, 1)"></td>
        <td onclick="makeMove(1, 2)"></td>
      </tr>
      <tr>
        <td onclick="makeMove(2, 0)"></td>
        <td onclick="makeMove(2, 1)"></td>
        <td onclick="makeMove(2, 2)"></td>
      </tr>
    </table>
    <div class="message"></div>
  </main>

  <script>
    (function () {
      var boardElement = document.querySelector('.board');
      var messageElement = document.querySelector('.message');
      var winningLines = [
        [0, 1, 2],
        [3, 4, 5],
        [6, 7, 8],
        [0, 3, 6],
        [1, 4, 7],
        [2, 5, 8],
        [0, 4, 8],
        [2, 4, 6]
      ];
      var gameState;

      function createGame() {
        return {
          board: [
            [null, null, null],
            [null, null, null],
            [null, null, null]
          ],
          currentPlayer: 'X',
          moves: 0,
          result: null
        };
      }

      function cloneBoard(board) {
        return board.map(function (row) {
          return row.slice();
        });
      }

      function isLegalMove(state, index) {
        var row = Math.floor(index / 3);
        var col = index % 3;

        return state.result === null && state.board[row][col] === null;
      }

      function winner(state) {
        var board = state.board;

        for (var i = 0; i < winningLines.length; i++) {
          var line = winningLines[i];
          var first = board[Math.floor(line[0] / 3)][line[0] % 3];

          if (first === null) {
            continue;
          }

          var second = board[Math.floor(line[1] / 3)][line[1] % 3];
          var third = board[Math.floor(line[2] / 3)][line[2] % 3];

          if (first === second && first === third) {
            return first;
          }
        }

        if (state.moves === 9) {
          return 'draw';
        }

        return null;
      }

      function applyMove(state, index) {
        if (!isLegalMove(state, index)) {
          return state;
        }

        var row = Math.floor(index / 3);
        var col = index % 3;
        var nextBoard = cloneBoard(state.board);

        nextBoard[row][col] = state.currentPlayer;

        var moves = state.moves + 1;
        var result = winner({ board: nextBoard, moves: moves });
        var nextPlayer = state.currentPlayer === 'X' ? 'O' : 'X';

        return {
          board: nextBoard,
          currentPlayer: result ? state.currentPlayer : nextPlayer,
          moves: moves,
          result: result
        };
      }

      function renderBoard(state) {
        for (var row = 0; row < 3; row++) {
          for (var col = 0; col < 3; col++) {
            var cell = boardElement.rows[row].cells[col];
            var value = state.board[row][col];

            cell.textContent = value === null ? '' : value;
          }
        }
      }

      function updateGlobals(state) {
        window.gameState = state;
        window.board = state.board;
        window.currentPlayer = state.currentPlayer;
        window.gameOver = state.result !== null;
      }

      function reset() {
        gameState = createGame();
        updateGlobals(gameState);
        renderBoard(gameState);
        messageElement.textContent = '';
      }

      window.makeMove = function (row, col) {
        var index = row * 3 + col;

        if (!isLegalMove(gameState, index)) {
          return;
        }

        var nextState = applyMove(gameState, index);

        if (nextState === gameState) {
          return;
        }

        gameState = nextState;
        updateGlobals(gameState);
        renderBoard(gameState);

        if (gameState.result === 'draw') {
          messageElement.textContent = "It's a draw!";
        } else if (gameState.result) {
          messageElement.textContent = gameState.result + ' Wins!';
        } else {
          messageElement.textContent = '';
        }
      };

      window.createGame = createGame;
      window.isLegalMove = isLegalMove;
      window.applyMove = applyMove;
      window.winner = winner;
      window.resetGameState = reset;

      reset();
    })();
  </script>
  <script>
    window.addEventListener('load', function () {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .register('./sw.js')
          .catch(function (error) {
            console.error('Service worker registration failed:', error);
          });
      }
    });
  </script>
</body>
</html>
